{% extends "base.html" %} {% block title %}All Analyses - Solana AI{% endblock
%} {% block content %}
<div x-data="analysesData()" x-init="init()">
  <!-- Page Header -->
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">All Analyses</h1>
        <p class="text-gray-600 mt-1">
          Complete history of token analyses with advanced filtering
        </p>
      </div>
      <div class="flex items-center space-x-3">
        <button
          @click="clearFilters()"
          x-show="hasActiveFilters"
          class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
        >
          <i class="fas fa-times mr-2"></i>
          Clear Filters
        </button>
        <button
          @click="loadAnalyses()"
          :disabled="isLoading"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50"
        >
          <i
            class="fas fa-sync-alt mr-2"
            :class="{ 'animate-spin': isLoading }"
          ></i>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- ChromaDB Status Banner -->
  <div
    x-show="!chromaDbAvailable && !isLoading"
    class="mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg"
  >
    <div class="flex">
      <div class="flex-shrink-0">
        <i class="fas fa-database text-yellow-400"></i>
      </div>
      <div class="ml-3">
        <h3 class="text-sm font-medium text-yellow-800">
          Analysis History Unavailable
        </h3>
        <div class="mt-2 text-sm text-yellow-700">
          <p>
            ChromaDB is not connected. Analysis history cannot be displayed.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold text-gray-900">Filters</h2>
      <button
        @click="showAdvancedFilters = !showAdvancedFilters"
        class="text-blue-600 hover:text-blue-800 text-sm font-medium"
      >
        <span x-show="!showAdvancedFilters">Show Advanced</span>
        <span x-show="showAdvancedFilters">Hide Advanced</span>
        <i
          class="fas fa-chevron-down ml-1 transition-transform"
          :class="{ 'rotate-180': showAdvancedFilters }"
        ></i>
      </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <!-- Search -->
      <div>
        <label class="form-label">Search</label>
        <input
          type="text"
          x-model="filters.search"
          @input="debouncedSearch()"
          placeholder="Search by token symbol or name..."
          class="form-input"
        />
      </div>

      <!-- Source Event -->
      <div>
        <label class="form-label">Source</label>
        <select
          x-model="filters.source_event"
          @change="applyFilters()"
          class="form-input form-select"
        >
          <option value="">All Sources</option>
          <option value="api_quick">API Quick</option>
          <option value="api_deep">API Deep</option>
          <option value="webhook">Webhook</option>
          <option value="social_alert">Social Alert</option>
        </select>
      </div>

      <!-- Risk Level -->
      <div>
        <label class="form-label">Risk Level</label>
        <select
          x-model="filters.risk_level"
          @change="applyFilters()"
          class="form-input form-select"
        >
          <option value="">All Levels</option>
          <option value="low">Low Risk</option>
          <option value="medium">Medium Risk</option>
          <option value="high">High Risk</option>
          <option value="critical">Critical Risk</option>
        </select>
      </div>

      <!-- Security Status -->
      <div>
        <label class="form-label">Security Status</label>
        <select
          x-model="filters.security_status"
          @change="applyFilters()"
          class="form-input form-select"
        >
          <option value="">All Statuses</option>
          <option value="passed">Secure</option>
          <option value="warning">Caution</option>
          <option value="failed">Unsafe</option>
        </select>
      </div>
    </div>

    <!-- Advanced Filters -->
    <div
      x-show="showAdvancedFilters"
      x-transition:enter="transition ease-out duration-200"
      x-transition:enter-start="opacity-0 transform -translate-y-2"
      x-transition:enter-end="opacity-100 transform translate-y-0"
      x-transition:leave="transition ease-in duration-150"
      x-transition:leave-start="opacity-100 transform translate-y-0"
      x-transition:leave-end="opacity-0 transform -translate-y-2"
      class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-gray-200"
    >
      <!-- Date From -->
      <div>
        <label class="form-label">Date From</label>
        <input
          type="date"
          x-model="filters.date_from"
          @change="applyFilters()"
          class="form-input"
        />
      </div>

      <!-- Date To -->
      <div>
        <label class="form-label">Date To</label>
        <input
          type="date"
          x-model="filters.date_to"
          @change="applyFilters()"
          class="form-input"
        />
      </div>
    </div>

    <!-- Active Filters Display -->
    <div x-show="hasActiveFilters" class="mt-4 pt-4 border-t border-gray-200">
      <div class="flex items-center space-x-2 flex-wrap">
        <span class="text-sm text-gray-600">Active filters:</span>

        <template
          x-for="([key, value], index) in Object.entries(getActiveFilters())"
          :key="`filter-${key}-${index}`"
        >
          <span
            class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
          >
            <span x-text="`${key.replace('_', ' ')}: ${value}`"></span>
            <button
              @click="removeFilter(key)"
              class="ml-1 text-blue-600 hover:text-blue-800"
            >
              <i class="fas fa-times text-xs"></i>
            </button>
          </span>
        </template>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div class="bg-white rounded-xl shadow-lg">
    <div class="overflow-x-auto">
      <table class="min-w-full">
        <!-- Table Header -->
        <thead>
          <tr class="bg-gray-100 text-gray-700 text-sm font-semibold">
            <th class="px-6 py-3 text-left">Token</th>
            <th class="px-6 py-3 text-left">Source</th>
            <th class="px-6 py-3 text-left">Risk Level</th>
            <th class="px-6 py-3 text-left">Security Status</th>
            <th class="px-6 py-3 text-left">Analysis Score</th>
            <th class="px-6 py-3 text-left">Actions</th>
          </tr>
        </thead>

        <!-- Table Body -->
        <tbody>
          <!-- IMPORTANT: Add validation and sorting to ensure consistent data -->
          <template
            x-for="analysis in sortedAnalyses"
            :key="analysis?.id || analysis?.mint"
          >
            <tr class="hover:bg-gray-50 border-b border-gray-200">
              <!-- Token Info -->
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center space-x-3">
                  <!-- Token Icon -->
                  <div class="w-10 h-10 rounded-full overflow-hidden">
                    <img
                      x-bind:src="`https://cryptoicon-api.vercel.app/api/icon/${analysis.token_symbol.toLowerCase()}`"
                      alt="Token Icon"
                      class="w-full h-full object-cover"
                    />
                  </div>
                  <!-- Token Details -->
                  <div class="min-w-0 flex-1">
                    <p
                      class="text-sm font-medium text-gray-900 truncate"
                      x-text="analysis.token_symbol || 'Unknown'"
                    ></p>
                    <p
                      class="text-xs text-gray-500 truncate"
                      x-text="analysis.token_name || 'Unknown Token'"
                    ></p>
                  </div>
                </div>
              </td>

              <!-- Source -->
              <td class="px-6 py-4 whitespace-nowrap">
                <span
                  class="text-xs rounded-full font-medium px-3 py-1"
                  :class="{
                    'bg-blue-100 text-blue-800': analysis.source_event === 'api_quick',
                    'bg-green-100 text-green-800': analysis.source_event === 'api_deep',
                    'bg-yellow-100 text-yellow-800': analysis.source_event === 'webhook',
                    'bg-red-100 text-red-800': analysis.source_event === 'social_alert',
                    'bg-gray-100 text-gray-800': !analysis.source_event
                  }"
                  x-text="
                    analysis.source_event
                      ? analysis.source_event.replace('_', ' ').toUpperCase()
                      : 'UNKNOWN'
                  "
                ></span>
              </td>

              <!-- Risk Level -->
              <td class="px-6 py-4 whitespace-nowrap">
                <span
                  class="text-xs rounded-full font-medium px-3 py-1"
                  :class="{
                    'bg-green-100 text-green-800': analysis.risk_level === 'low',
                    'bg-yellow-100 text-yellow-800': analysis.risk_level === 'medium',
                    'bg-orange-100 text-orange-800': analysis.risk_level === 'high',
                    'bg-red-100 text-red-800': analysis.risk_level === 'critical',
                    'bg-gray-100 text-gray-800': analysis.risk_level === 'unknown'
                  }"
                  x-text="(analysis.risk_level || 'unknown').toUpperCase() + ' RISK'"
                ></span>
              </td>

              <!-- Security Status -->
              <td class="px-6 py-4 whitespace-nowrap">
                <span
                  class="text-xs rounded-full font-medium px-3 py-1"
                  :class="{
                    'bg-green-100 text-green-800': analysis.security_status === 'passed',
                    'bg-red-100 text-red-800': analysis.security_status === 'failed',
                    'bg-yellow-100 text-yellow-800': analysis.security_status === 'warning',
                    'bg-gray-100 text-gray-800': analysis.security_status === 'unknown'
                  }"
                >
                  <i class="fas fa-shield-alt mr-1"></i>
                  <span
                    x-text="analysis.security_status === 'passed' ? 'SECURE' : 
                                 analysis.security_status === 'failed' ? 'UNSAFE' :
                                 analysis.security_status === 'warning' ? 'CAUTION' : 'UNKNOWN'"
                  ></span>
                </span>
              </td>

              <!-- Analysis Score -->
              <td class="px-6 py-4 whitespace-nowrap text-right">
                <div
                  class="text-sm font-bold"
                  :class="{
                       'text-green-600': analysis.overall_score >= 80,
                       'text-yellow-600': analysis.overall_score >= 60 && analysis.overall_score < 80,
                       'text-orange-600': analysis.overall_score >= 40 && analysis.overall_score < 60,
                       'text-red-600': analysis.overall_score < 40,
                       'text-gray-500': !analysis.overall_score
                     }"
                  x-text="analysis.overall_score ? Math.round(analysis.overall_score) + '%' : 'N/A'"
                ></div>
              </td>

              <!-- Actions -->
              <td class="px-6 py-4 whitespace-nowrap text-right">
                <button
                  @click.stop="openAnalysisPopup(analysis)"
                  class="px-3 py-1 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors"
                >
                  <i class="fas fa-eye mr-1"></i>
                  View Details
                </button>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>

    <!-- No Results Message -->
    <div
      x-show="!isLoading && (!analyses || analyses.length === 0)"
      class="p-6 text-center text-gray-500"
    >
      No analyses found
    </div>
  </div>
</div>

<script>
  function analysesData() {
    return {
      // Initialize ALL properties upfront
      analyses: [],
      perPage: 20,
      chromaDbAvailable: false,
      showAdvancedFilters: false,
      isLoading: false,
      pagination: {
        page: 1,
        total_pages: 1,
        total_items: 0,
        has_prev: false,
        has_next: false,
        per_page: 20,
      },
      filters: {
        search: "",
        source_event: "",
        risk_level: "",
        security_status: "",
        date_from: "",
        date_to: "",
      },
      debouncedSearch: null,

      // Debounce helper
      debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func.apply(this, args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        }.bind(this);
      },

      init() {
        console.log("✅ Initializing analyses data...");

        // Initialize search debounce AFTER debounce is defined
        this.debouncedSearch = this.debounce(() => {
          if (this.filters && typeof this.filters.search !== "undefined") {
            this.handleSearch(this.filters.search);
          }
        }, 300);

        // Load initial data
        this.loadAnalyses();

        console.log("✅ Analyses data initialized");
      },

      async handleSearch(query = "") {
        this.isLoading = true;
        try {
          const searchTerm = (query || "").toLowerCase().trim();
          if (!searchTerm) {
            await this.loadAnalyses();
            return;
          }
          await this.searchAnalyses(searchTerm);
        } catch (error) {
          console.error("Search failed:", error);
        } finally {
          this.isLoading = false;
        }
      },

      async loadAnalyses(page = 1) {
        this.isLoading = true;

        try {
          const params = new URLSearchParams({
            page: page.toString(),
            per_page: this.perPage.toString(),
          });

          // Add filters to params
          Object.keys(this.filters).forEach((key) => {
            if (this.filters[key]) {
              params.append(key, this.filters[key]);
            }
          });

          const response = await fetch(`/api/analyses?${params}`);
          const data = await response.json();

          // Ensure analyses is always an array
          this.analyses = Array.isArray(data.analyses) ? data.analyses : [];

          // Ensure pagination is properly set
          this.pagination = data.pagination || {
            page: 1,
            total_pages: 1,
            total_items: 0,
            has_prev: false,
            has_next: false,
            per_page: this.perPage,
          };

          this.chromaDbAvailable = data.chromadb_available || false;

          console.log("✅ Loaded analyses:", this.analyses.length, "items");
        } catch (error) {
          console.error("Failed to load analyses:", error);
          this.showNotification(
            "error",
            "Load Failed",
            "Failed to load analyses"
          );
          // Ensure safe defaults on error
          this.analyses = [];
        } finally {
          this.isLoading = false;
        }
      },

      applyFilters() {
        this.loadAnalyses(1); // Reset to first page when filtering
      },

      async searchAnalyses(query = "") {
        this.isLoading = true;
        try {
          if (!query.trim()) {
            await this.loadAnalyses();
            return;
          }

          const params = new URLSearchParams({
            search: query.trim(),
            page: "1",
            per_page: this.perPage.toString(),
          });

          const response = await fetch(`/api/analyses?${params}`);
          const data = await response.json();

          this.analyses = Array.isArray(data.analyses) ? data.analyses : [];
          this.pagination = data.pagination || {
            page: 1,
            total_pages: 1,
            total_items: 0,
            has_prev: false,
            has_next: false,
            per_page: this.perPage,
          };
        } catch (error) {
          console.error("Search failed:", error);
          this.showNotification(
            "error",
            "Search Failed",
            "Failed to search analyses"
          );
        } finally {
          this.isLoading = false;
        }
      },

      debouncedSearch: debounce(function () {
        if (typeof this.filters.search === "string") {
          this.searchAnalyses(this.filters.search);
        }
      }, 300),

      clearFilters() {
        this.filters = {
          search: "",
          source_event: "",
          risk_level: "",
          security_status: "",
          date_from: "",
          date_to: "",
        };
        this.loadAnalyses(1);
      },

      removeFilter(key) {
        this.filters[key] = "";
        this.applyFilters();
      },

      changePerPage() {
        this.loadAnalyses(1);
      },

      goToPage(page) {
        if (page >= 1 && page <= this.pagination.total_pages) {
          this.loadAnalyses(page);
        }
      },

      get hasActiveFilters() {
        return Object.values(this.filters).some((value) => value !== "");
      },

      getActiveFilters() {
        const active = {};
        Object.keys(this.filters).forEach((key) => {
          if (this.filters[key]) {
            active[key] = this.filters[key];
          }
        });
        return active;
      },

      getShowingText() {
        if (!this.pagination) return "";
        const start = (this.pagination.page - 1) * this.pagination.per_page + 1;
        const end = Math.min(
          start + this.pagination.per_page - 1,
          this.pagination.total_items
        );
        return `${start}-${end} of ${this.pagination.total_items}`;
      },

      getVisiblePages() {
        if (!this.pagination) return [];
        const current = this.pagination.page;
        const total = this.pagination.total_pages;
        const pages = [];

        if (total <= 7) {
          for (let i = 1; i <= total; i++) {
            pages.push(i);
          }
        } else {
          pages.push(1);
          if (current > 4) pages.push("...");

          const start = Math.max(2, current - 1);
          const end = Math.min(total - 1, current + 1);

          for (let i = start; i <= end; i++) {
            if (i !== 1 && i !== total) {
              pages.push(i);
            }
          }

          if (current < total - 3) pages.push("...");
          if (total > 1) pages.push(total);
        }

        return pages;
      },

      // Date formatting function
      formatDate(timestamp) {
        if (!timestamp) return "Unknown";
        try {
          let date;
          if (typeof timestamp === "string") {
            date = new Date(timestamp);
          } else if (typeof timestamp === "number") {
            date = new Date(timestamp < 1e12 ? timestamp * 1000 : timestamp);
          } else {
            return "Unknown";
          }

          if (isNaN(date.getTime())) return "Invalid date";

          const day = String(date.getDate()).padStart(2, "0");
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const year = date.getFullYear();

          return `${day}.${month}.${year}`;
        } catch (error) {
          return "Invalid date";
        }
      },

      openAnalysisPopup(analysisData) {
        if (window.openAnalysisPopupGlobal) {
          window.openAnalysisPopupGlobal(analysisData);
        } else if (this.$root && this.$root.openAnalysisPopup) {
          this.$root.openAnalysisPopup(analysisData);
        } else {
          // Fallback to local popup creation
          this.createPopupHTML(analysisData);
        }
      },

      createPopupHTML(analysis) {
        // Remove existing popup if any
        const existingPopup = document.getElementById("analysis-popup");
        if (existingPopup) {
          existingPopup.remove();
        }

        // Create popup HTML
        const popupHTML = `
            <div id="analysis-popup" class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4">
              <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <!-- Header -->
                <div class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-xl">
                  <div class="flex justify-between items-center">
                    <div>
                      <h2 class="text-2xl font-bold">${
                        analysis.token_symbol || "Unknown"
                      } Analysis</h2>
                      <p class="opacity-90">${
                        analysis.token_name || "Token Analysis Results"
                      }</p>
                    </div>
                    <button onclick="closeAnalysisPopupManual()" class="text-white hover:text-gray-300 text-2xl">
                      &times;
                    </button>
                  </div>
                </div>

                <!-- Content -->
                <div class="p-6">
                  <!-- Status Cards -->
                  <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <!-- Security -->
                    <div class="text-center p-4 rounded-lg border-2 ${this.getSecurityCardClass(
                      analysis.security_status
                    )}">
                      <div class="text-2xl mb-2 ${this.getSecurityIconClass(
                        analysis.security_status
                      )}">🛡️</div>
                      <div class="font-bold">${this.getSecurityText(
                        analysis.security_status
                      )}</div>
                      <div class="text-xs text-gray-500">Security</div>
                    </div>

                    <!-- Score -->
                    <div class="text-center p-4 rounded-lg bg-blue-50 border-2 border-blue-200">
                      <div class="text-2xl mb-2 text-blue-600">⭐</div>
                      <div class="font-bold text-blue-900">${
                        analysis.overall_score
                          ? Math.round(analysis.overall_score) + "%"
                          : "N/A"
                      }</div>
                      <div class="text-xs text-gray-500">Score</div>
                    </div>

                    <!-- Risk -->
                    <div class="text-center p-4 rounded-lg border-2 ${this.getRiskCardClass(
                      analysis.risk_level
                    )}">
                      <div class="text-2xl mb-2 ${this.getRiskIconClass(
                        analysis.risk_level
                      )}">⚠️</div>
                      <div class="font-bold">${(
                        analysis.risk_level || "unknown"
                      ).toUpperCase()}</div>
                      <div class="text-xs text-gray-500">Risk</div>
                    </div>

                    <!-- Recommendation -->
                    <div class="text-center p-4 rounded-lg bg-purple-50 border-2 border-purple-200">
                      <div class="text-2xl mb-2 text-purple-600">👍</div>
                      <div class="font-bold text-purple-900">${(
                        analysis.recommendation || "unknown"
                      ).toUpperCase()}</div>
                      <div class="text-xs text-gray-500">Action</div>
                    </div>
                  </div>

                  <!-- Security Details -->
                  <div class="mb-6">
                    <h3 class="font-bold text-lg mb-3">🔍 Security Details</h3>

                    ${
                      analysis.critical_issues > 0
                        ? `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-3 rounded-r-lg">
                      <div class="flex items-center mb-2">
                        <span class="text-red-500 text-xl mr-2">🚨</span>
                        <div class="font-bold text-red-800">Critical Security Issues</div>
                      </div>
                      <div class="text-red-700 mb-2">${analysis.critical_issues} critical issue(s) detected</div>
                      <div class="text-sm text-red-600 bg-red-100 p-2 rounded">
                        <strong>⚠️ High Risk:</strong> This token has failed critical security checks.
                      </div>
                    </div>
                    `
                        : ""
                    }

                    ${
                      analysis.warnings > 0
                        ? `
                    <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-3 rounded-r-lg">
                      <div class="flex items-center mb-2">
                        <span class="text-yellow-500 text-xl mr-2">⚠️</span>
                        <div class="font-bold text-yellow-800">Security Warnings</div>
                      </div>
                      <div class="text-yellow-700 mb-2">${analysis.warnings} warning(s) detected</div>
                      <div class="text-sm text-yellow-700 bg-yellow-100 p-2 rounded">
                        <strong>⚠️ Moderate Risk:</strong> This token has some concerning features.
                      </div>
                    </div>
                    `
                        : ""
                    }

                    ${
                      analysis.critical_issues === 0 &&
                      analysis.warnings === 0 &&
                      analysis.security_status === "passed"
                        ? `
                    <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-3 rounded-r-lg">
                      <div class="flex items-center mb-2">
                        <span class="text-green-500 text-xl mr-2">✅</span>
                        <div class="font-bold text-green-800">Security Verified</div>
                      </div>
                      <div class="text-sm text-green-700 bg-green-100 p-2 rounded">
                        <strong>✅ Low Risk:</strong> This token has passed all security checks.
                      </div>
                    </div>
                    `
                        : ""
                    }

                    <!-- Analysis Info -->
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                      <div class="flex items-center mb-2">
                        <span class="text-blue-500 text-xl mr-2">ℹ️</span>
                        <div class="font-bold text-blue-800">Analysis Information</div>
                      </div>
                      <div class="text-sm text-blue-700 space-y-1">
                        <div><strong>Processed:</strong> ${this.formatDate(
                          analysis.timestamp
                        )}</div>
                        <div><strong>Processing Time:</strong> ${(
                          analysis.processing_time || 0
                        ).toFixed(2)}s</div>
                        <div><strong>Source:</strong> ${(
                          analysis.source_event || "unknown"
                        ).replace("_", " ")}</div>
                        ${
                          analysis.id
                            ? `<div><strong>Analysis ID:</strong> <code class="text-xs bg-blue-100 px-1 rounded">${analysis.id.substring(
                                0,
                                16
                              )}...</code></div>`
                            : ""
                        }
                      </div>
                    </div>
                  </div>

                  <!-- Token Address -->
                  <div class="bg-gray-50 rounded-lg p-4 mb-6">
                    <div class="font-bold mb-2">📋 Contract Address</div>
                    <div class="flex items-center justify-between">
                      <code class="text-sm bg-white px-2 py-1 rounded break-all">${
                        analysis.mint || "N/A"
                      }</code>
                      ${
                        analysis.mint
                          ? `<button
                          onclick="copyToClipboardManual('${analysis.mint}')"
                          class="ml-2 px-3 py-1 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700 transition-colors"
                        >
                          <i class="fas fa-copy mr-1"></i>
                          Copy Address
                        </button>`
                          : ""
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;

        // Insert popup into DOM
        document.body.insertAdjacentHTML("beforeend", popupHTML);

        // Add event listeners
        document
          .getElementById("analysis-popup")
          .addEventListener("click", function (e) {
            if (e.target.id === "analysis-popup") {
              closeAnalysisPopupManual();
            }
          });

        // Add escape key listener
        document.addEventListener("keydown", function (e) {
          if (e.key === "Escape") {
            closeAnalysisPopupManual();
          }
        });
      },

      getSecurityCardClass(status) {
        const classes = {
          passed: "bg-green-50 border-green-200",
          failed: "bg-red-50 border-red-200",
          warning: "bg-yellow-50 border-yellow-200",
        };
        return classes[status] || "bg-gray-50 border-gray-200";
      },

      getSecurityIconClass(status) {
        const classes = {
          passed: "text-green-600",
          failed: "text-red-600",
          warning: "text-yellow-600",
        };
        return classes[status] || "text-gray-600";
      },

      getSecurityText(status) {
        const texts = {
          passed: "SECURE",
          failed: "UNSAFE",
          warning: "CAUTION",
        };
        return texts[status] || "UNKNOWN";
      },

      getRiskCardClass(level) {
        const classes = {
          low: "bg-green-50 border-green-200",
          medium: "bg-yellow-50 border-yellow-200",
          high: "bg-orange-50 border-orange-200",
          critical: "bg-red-50 border-red-200",
        };
        return classes[level] || "bg-gray-50 border-gray-200";
      },

      getRiskIconClass(level) {
        const classes = {
          low: "text-green-600",
          medium: "text-yellow-600",
          high: "text-orange-600",
          critical: "text-red-600",
        };
        return classes[level] || "text-gray-600";
      },

      async copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          this.showNotification(
            "success",
            "Copied",
            "Address copied to clipboard"
          );
        } catch (error) {
          this.showNotification(
            "error",
            "Copy Failed",
            "Failed to copy to clipboard"
          );
        }
      },

      showNotification(type, title, message) {
        if (window.SolanaAI && window.SolanaAI.notifications) {
          window.SolanaAI.notifications[type](title, message);
        } else {
          console.log(`${type.toUpperCase()}: ${title} - ${message}`);
        }
      },

      // Add manual close function for popup
      closeAnalysisPopup() {
        const popup = document.getElementById("analysis-popup");
        if (popup) {
          popup.remove();
        }
        document.body.style.overflow = "";
      },

      // Add computed property for sorted and validated analyses
      get sortedAnalyses() {
        return (this.analyses || [])
          .filter((a) => a && (a.id || a.mint)) // Ensure valid key exists
          .map((a) => ({
            id: a.id || a.mint, // Ensure unique ID
            mint: a.mint || "unknown",
            token_symbol: a.token_symbol || "N/A",
            token_name: a.token_name || "Unknown",
            source_event: this.normalizeSourceEvent(a.source_event),
            timestamp: a.timestamp || new Date().toISOString(),
            // Add all other required properties with defaults
            ...a,
          }))
          .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort by timestamp
      },

      // Add helper to normalize source events
      normalizeSourceEvent(event) {
        if (!event) return "unknown";

        // Handle different source event formats
        if (event.startsWith("webhook_")) {
          return event.replace("webhook_", "Webhook: ");
        }
        if (event === "api_quick") return "API Quick";
        if (event === "api_deep") return "API Deep";
        if (event.includes("social")) return "Social Alert";

        return event;
      },

      // Update load function to ensure consistent data
      async loadAnalyses() {
        this.isLoading = true;
        try {
          const params = new URLSearchParams({
            page: (this.pagination?.page || 1).toString(),
            per_page: this.perPage.toString(),
            ...this.getActiveFilters(),
          });

          const response = await fetch(`/api/analyses?${params}`);
          const data = await response.json();

          // Validate data before assignment
          if (!Array.isArray(data.analyses)) {
            throw new Error("Invalid analyses data received");
          }

          // Assign with validation
          this.analyses = data.analyses;
          this.pagination = data.pagination || { page: 1, total_pages: 1 };
        } catch (error) {
          console.error("Failed to load analyses:", error);
          this.analyses = []; // Reset to safe value
          this.pagination = { page: 1, total_pages: 1 };
        } finally {
          this.isLoading = false;
        }
      },
    };
  }

  // Debounce helper function
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Global functions for popup
  window.closeAnalysisPopupManual = function () {
    const popup = document.getElementById("analysis-popup");
    if (popup) {
      popup.remove();
    }
    document.body.style.overflow = "";
  };

  window.copyToClipboardManual = async function (text) {
    try {
      await navigator.clipboard.writeText(text);
      // Show a simple notification
      const notification = document.createElement("div");
      notification.innerHTML = `
        <div class="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50">
          Address copied to clipboard!
        </div>
      `;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
      }, 2000);
    } catch (error) {
      console.error("Failed to copy:", error);
      alert("Failed to copy to clipboard");
    }
  };
</script>
{% endblock %}
