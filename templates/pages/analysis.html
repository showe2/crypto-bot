{% extends "base.html" %} {% block title %}Token Analysis - Solana AI{% endblock
%} {% block content %}
<div x-data="analysisData()" x-init="initAnalysis()">
  <!-- Page Header -->
  <div class="mb-8">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold text-gray-900">Token Analysis</h1>
        <p class="text-gray-600 mt-1">
          Comprehensive AI-powered cryptocurrency analysis
        </p>
      </div>
      <div class="flex items-center space-x-3">
        <button
          @click="clearResults()"
          x-show="hasResults"
          class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
        >
          <i class="fas fa-times mr-2"></i>
          Clear
        </button>
        <button
          @click="exportResults()"
          x-show="hasResults"
          class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
        >
          <i class="fas fa-download mr-2"></i>
          Export
        </button>
      </div>
    </div>
  </div>

  <!-- Analysis Form -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-900 mb-6">Analyze Token</h2>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Token Input -->
      <div class="lg:col-span-2">
        <label class="form-label">Token Mint Address</label>
        <div class="relative">
          <input
            type="text"
            x-model="form.tokenMint"
            @keyup.enter="analyzeToken()"
            placeholder="Enter Solana token mint address (32-44 characters)..."
            class="form-input pr-12"
            :class="{ 'border-red-500': form.tokenMint && !isValidAddress }"
            :disabled="isAnalyzing"
          />

          <!-- Paste button -->
          <button
            @click="pasteFromClipboard()"
            class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
            :disabled="isAnalyzing"
          >
            <i class="fas fa-clipboard"></i>
          </button>
        </div>

        <!-- Validation feedback -->
        <div
          x-show="form.tokenMint && !isValidAddress"
          class="mt-1 text-sm text-red-600"
        >
          <i class="fas fa-exclamation-circle mr-1"></i>
          Please enter a valid Solana token mint address
        </div>

        <!-- Quick Examples -->
        <div class="mt-3">
          <span class="text-sm text-gray-500">Examples:</span>
          <div class="flex flex-wrap gap-2 mt-1">
            {% for token in example_tokens %}
            <button
              @click="form.tokenMint = '{{ token.mint }}'"
              class="text-sm text-blue-600 hover:text-blue-800 underline"
              :disabled="isAnalyzing"
            >
              {{ token.name }} ({{ token.symbol }})
            </button>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Analysis Options -->
      <div class="space-y-4">
        <div>
          <label class="form-label">Analysis Type</label>
          <select
            x-model="form.analysisType"
            class="form-input form-select"
            :disabled="isAnalyzing"
          >
            <option value="quick">Quick Analysis (API)</option>
            <option value="deep">Deep Analysis (API+LLM)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Analyze Button -->
    <div class="mt-6">
      <button
        @click="analyzeToken()"
        :disabled="!isValidAddress || isAnalyzing"
        class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 text-white font-medium py-3 px-6 rounded-lg transition-colors"
      >
        <span x-show="!isAnalyzing" class="flex items-center justify-center">
          <i class="fas fa-search mr-2"></i>
          <span x-text="getAnalyzeButtonText()"></span>
        </span>
        <span x-show="isAnalyzing" class="flex items-center justify-center">
          <div class="loading-spinner mr-2"></div>
          <span x-text="analysisProgress.message"></span>
        </span>
      </button>

      <!-- Progress Bar -->
      <div x-show="isAnalyzing" class="mt-3">
        <div class="progress-bar">
          <div
            class="progress-bar-fill bg-blue-600"
            :style="`width: ${analysisProgress.percent}%`"
          ></div>
        </div>
        <div class="flex justify-between text-sm text-gray-600 mt-1">
          <span x-text="analysisProgress.step"></span>
          <span x-text="analysisProgress.percent + '%'"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Analysis Results -->
  <div x-show="hasResults" x-transition class="space-y-6">
    <!-- Token Overview -->
    <div x-show="results" class="bg-white rounded-xl shadow-lg p-6">
      <h3 class="text-xl font-semibold text-gray-900 mb-4">Token Overview</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Token Info -->
        <div class="text-center">
          <div
            class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-3"
          >
            <i class="fas fa-coins text-blue-600 text-2xl"></i>
          </div>
          <h4 class="font-semibold text-gray-900" x-text="getTokenName()"></h4>
          <p class="text-sm text-gray-500" x-text="getTokenSymbol()"></p>
          <p
            class="text-xs text-gray-400 font-mono mt-1"
            x-text="truncateAddress(results?.token_address || form.tokenMint)"
          ></p>
        </div>

        <!-- Price Data -->
        <div class="text-center" x-show="getPriceData().value">
          <div
            class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3"
          >
            <i class="fas fa-dollar-sign text-green-600 text-2xl"></i>
          </div>
          <h4
            class="font-semibold text-gray-900"
            x-text="formatCurrency(getPriceData().value)"
          ></h4>
          <p
            class="text-sm"
            :class="getPriceChangeClass(getPriceData().price_change_24h)"
            x-text="formatPercent(getPriceData().price_change_24h)"
          ></p>
          <p class="text-xs text-gray-400">24h Change</p>
        </div>

        <!-- Market Cap -->
        <div class="text-center" x-show="getPriceData().liquidity">
          <div
            class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-3"
          >
            <i class="fas fa-chart-pie text-purple-600 text-2xl"></i>
          </div>
          <h4
            class="font-semibold text-gray-900"
            x-text="formatNumber(getPriceData().market_cap)"
          ></h4>
          <p class="text-sm text-gray-500">Market Cap</p>
          <p
            class="text-xs text-gray-400"
            x-text="formatNumber(getPriceData().volume_24h) + ' Vol'"
          ></p>
        </div>

        <!-- Analysis Score -->
        <div class="text-center" x-show="getAnalysisScore() !== null">
          <div
            class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-3"
          >
            <i class="fas fa-star text-yellow-600 text-2xl"></i>
          </div>
          <h4
            class="font-semibold text-gray-900"
            x-text="getAnalysisScore() ? getAnalysisScore() + '%' : 'N/A'"
          ></h4>
          <p class="text-sm text-gray-500">Analysis Score</p>
          <p class="text-xs text-gray-400" x-text="getRiskLevel()"></p>
        </div>
      </div>
    </div>

    <!-- Analysis Results Cards -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Quick Analysis -->
      <div
        x-show="getQuickAnalysis()"
        class="bg-white rounded-xl shadow-lg p-6"
      >
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Quick Analysis</h3>
          <div class="flex items-center space-x-2">
            <i class="fas fa-bolt text-yellow-500"></i>
            <span class="text-sm text-gray-500">Frontend</span>
          </div>
        </div>

        <template x-if="getQuickAnalysis()">
          <div class="space-y-4">
            <!-- Score -->
            <div class="text-center p-4 bg-gray-50 rounded-lg">
              <div
                class="text-3xl font-bold text-blue-600"
                x-text="Math.round((getQuickAnalysis().score || 0) * 100)"
              ></div>
              <div class="text-sm text-gray-500">Overall Score</div>
              <div class="progress-bar mt-2">
                <div
                  class="progress-bar-fill bg-blue-600"
                  :style="`width: ${(getQuickAnalysis().score || 0) * 100}%`"
                ></div>
              </div>
            </div>

            <!-- Risk and Recommendation -->
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <span class="text-gray-700">Risk Level:</span>
                <span
                  class="px-3 py-1 rounded-full text-sm font-medium"
                  :class="getRiskLevelClass(getQuickAnalysis().risk_level)"
                  x-text="(getQuickAnalysis().risk_level || 'unknown').toUpperCase()"
                ></span>
              </div>

              <div class="flex items-center justify-between">
                <span class="text-gray-700">Recommendation:</span>
                <span
                  class="px-3 py-1 rounded-full text-sm font-medium"
                  :class="getRecommendationClass(getQuickAnalysis().recommendation)"
                  x-text="getQuickAnalysis().recommendation || 'HOLD'"
                ></span>
              </div>
            </div>

            <!-- Key Insights -->
            <div x-show="getQuickAnalysis().key_insights?.length">
              <h4 class="font-medium text-gray-900 mb-2">Key Insights:</h4>
              <ul class="space-y-1">
                <template
                  x-for="insight in getQuickAnalysis().key_insights"
                  :key="insight"
                >
                  <li class="text-sm text-gray-600 flex items-start">
                    <i
                      class="fas fa-chevron-right text-blue-500 mr-2 mt-0.5 text-xs"
                    ></i>
                    <span x-text="insight"></span>
                  </li>
                </template>
              </ul>
            </div>

            <!-- Processing Time -->
            <div class="text-xs text-gray-500 text-center">
              Processed in
              <span
                x-text="(getQuickAnalysis().processing_time || 0).toFixed(2)"
              ></span
              >s
            </div>
          </div>
        </template>
      </div>

      <!-- Deep Analysis -->
      <div x-show="getDeepAnalysis()" class="bg-white rounded-xl shadow-lg p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-gray-900">Deep Analysis</h3>
          <div class="flex items-center space-x-2">
            <i class="fas fa-brain text-purple-500"></i>
            <span class="text-sm text-gray-500">LLM Enhanced</span>
          </div>
        </div>

        <template x-if="getDeepAnalysis()">
          <div class="space-y-4">
            <!-- Pump Probabilities -->
            <div class="grid grid-cols-2 gap-4">
              <div class="text-center p-3 bg-gray-50 rounded-lg">
                <div
                  class="text-xl font-bold text-green-600"
                  x-text="Math.round((getDeepAnalysis().pump_probability_1h || 0) * 100) + '%'"
                ></div>
                <div class="text-xs text-gray-500">1h Pump Probability</div>
              </div>
              <div class="text-center p-3 bg-gray-50 rounded-lg">
                <div
                  class="text-xl font-bold text-blue-600"
                  x-text="Math.round((getDeepAnalysis().pump_probability_24h || 0) * 100) + '%'"
                ></div>
                <div class="text-xs text-gray-500">24h Pump Probability</div>
              </div>
            </div>

            <!-- Patterns -->
            <div x-show="getDeepAnalysis().patterns?.length">
              <h4 class="font-medium text-gray-900 mb-2">Detected Patterns:</h4>
              <div class="flex flex-wrap gap-1">
                <template
                  x-for="pattern in getDeepAnalysis().patterns"
                  :key="pattern"
                >
                  <span
                    class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full"
                    x-text="pattern.replace('_', ' ')"
                  ></span>
                </template>
              </div>
            </div>

            <!-- Price Targets -->
            <div
              x-show="getDeepAnalysis().price_targets && Object.keys(getDeepAnalysis().price_targets).length"
            >
              <h4 class="font-medium text-gray-900 mb-2">Price Targets:</h4>
              <div class="space-y-1">
                <template
                  x-for="[timeframe, target] in Object.entries(getDeepAnalysis().price_targets || {})"
                  :key="timeframe"
                >
                  <div class="flex justify-between text-sm">
                    <span class="text-gray-600" x-text="timeframe"></span>
                    <span
                      class="font-medium"
                      x-text="formatCurrency(target)"
                    ></span>
                  </div>
                </template>
              </div>
            </div>

            <!-- Processing Time -->
            <div class="text-xs text-gray-500 text-center">
              Processed in
              <span
                x-text="(getDeepAnalysis().processing_time || 0).toFixed(2)"
              ></span
              >s
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Comprehensive Analysis Details -->
    <div
      x-show="isComprehensiveAnalysis()"
      class="bg-white rounded-xl shadow-lg p-6"
    >
      <h3 class="text-lg font-semibold text-gray-900 mb-4">
        Comprehensive Analysis Details
      </h3>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Security Analysis -->
        <div x-show="getSecurityAnalysis()">
          <h4 class="font-medium text-gray-900 mb-2">Security Score</h4>
          <div class="text-center p-3 bg-gray-50 rounded-lg">
            <div
              class="text-2xl font-bold"
              :class="(getSecurityAnalysis()?.overall_security_score || 0) >= 70 ? 'text-green-600' : (getSecurityAnalysis()?.overall_security_score || 0) >= 40 ? 'text-yellow-600' : 'text-red-600'"
              x-text="getSecurityAnalysis()?.overall_security_score || 'N/A'"
            ></div>
            <div class="text-xs text-gray-500">Security Score</div>
          </div>
        </div>

        <!-- On-Chain Metrics -->
        <div x-show="getOnChainMetrics()">
          <h4 class="font-medium text-gray-900 mb-2">On-Chain Activity</h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Holder Count:</span>
              <span
                x-text="formatNumber(getOnChainMetrics()?.holder_analysis?.holder_count || 0)"
              ></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">24h Transactions:</span>
              <span
                x-text="formatNumber(getOnChainMetrics()?.transaction_activity?.['24h_transactions'] || 0)"
              ></span>
            </div>
          </div>
        </div>

        <!-- Risk Assessment -->
        <div x-show="getRiskAssessment()">
          <h4 class="font-medium text-gray-900 mb-2">Risk Breakdown</h4>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Overall Risk:</span>
              <span
                :class="getRiskLevelClass(getRiskAssessment()?.risk_category)"
                class="px-2 py-1 rounded text-xs"
                x-text="(getRiskAssessment()?.risk_category || 'unknown').toUpperCase()"
              ></span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">Score:</span>
              <span
                x-text="getRiskAssessment()?.overall_risk_score || 'N/A'"
              ></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Analysis Metadata -->
    <div class="bg-gray-50 rounded-xl p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">Analysis Details</h3>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
          <div class="text-sm text-gray-500">Analysis ID</div>
          <div
            class="font-mono text-sm"
            x-text="results?.analysis_id || 'N/A'"
          ></div>
        </div>
        <div>
          <div class="text-sm text-gray-500">Processing Time</div>
          <div
            class="font-medium"
            x-text="(results?.metadata.processing_time_seconds || 0).toFixed(2) + 's'"
          ></div>
        </div>
        <div>
          <div class="text-sm text-gray-500">Data Sources</div>
          <div
            class="font-medium"
            x-text="getDataSources().join(', ') || 'N/A'"
          ></div>
        </div>
        <div>
          <div class="text-sm text-gray-500">Analysis Date</div>
          <div
            class="font-medium"
            x-text="results?.timestamp ? new Date(results.timestamp).toLocaleDateString() : 'N/A'"
          ></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function analysisData() {
      return {
        form: {
          tokenMint: '{{ selected_token or "" }}',
          analysisType: "quick",
          priority: "normal",
          forceRefresh: false,
        },
        isAnalyzing: false,
        hasResults: false,
        results: null,
        analysisProgress: {
          step: "Initializing...",
          message: "Starting analysis...",
          percent: 0,
        },

        get isValidAddress() {
          return this.isValidSolanaAddress(this.form.tokenMint);
        },

        initAnalysis() {
          // Initialize with URL token if provided
          const urlParams = new URLSearchParams(window.location.search);
          const token = urlParams.get("token");
          if (token) {
            this.form.tokenMint = token;
            // Auto-analyze if valid token in URL
            if (this.isValidAddress) {
              setTimeout(() => this.analyzeToken(), 1000);
            }
          }
        },

        getAnalyzeButtonText() {
          switch (this.form.analysisType) {
            case "quick":
              return "Quick Analysis (Frontend API)";
            case "deep":
              return "Deep Analysis (LLM API)";
            case "comprehensive":
              return "Comprehensive Analysis (Full API)";
            default:
              return "Analyze Token";
          }
        },

        async analyzeToken() {
          console.log("🚀 Starting token analysis...", {
            tokenMint: this.form.tokenMint,
            analysisType: this.form.analysisType,
            isValidAddress: this.isValidAddress,
          });

          if (!this.isValidAddress) {
            console.error("❌ Invalid token address:", this.form.tokenMint);
            this.showNotification(
              "error",
              "Invalid Address",
              "Please enter a valid Solana token mint address"
            );
            return;
          }

          this.isAnalyzing = true;
          this.hasResults = false;
          this.results = null;

          try {
            // Check if SolanaAI is available
            if (!window.SolanaAI || !window.SolanaAI.api) {
              throw new Error(
                "SolanaAI API not loaded. Please refresh the page."
              );
            }

            console.log("📡 Making API call...", {
              endpoint: this.form.analysisType,
              tokenMint: this.form.tokenMint,
            });

            // Use the enhanced API from main.js
            const analysisOptions = {
              forceRefresh: this.form.forceRefresh,
              priority: this.form.priority,
            };

            let result;

            // Direct API calls based on analysis type
            switch (this.form.analysisType) {
              case "quick":
                result = await this.callQuickAnalysis(this.form.tokenMint);
                break;
              default:
                throw new Error(
                  `Unknown analysis type: ${this.form.analysisType}`
                );
            }

            console.log("✅ Analysis result received:", result);

            this.results = result;
            this.hasResults = true;

            const summary = window.SolanaAI.analysis.generateSummary(result);
            this.showNotification("success", "Analysis Complete", summary);
          } catch (error) {
            console.error("❌ Analysis error:", error);

            // More detailed error messages
            let errorMessage = error.message || "Failed to analyze token";

            if (error.message && error.message.includes("fetch")) {
              errorMessage = "Network error - please check your connection";
            } else if (error.message && error.message.includes("404")) {
              errorMessage = "Analysis endpoint not found";
            } else if (error.message && error.message.includes("422")) {
              errorMessage = "Invalid token address format";
            } else if (error.message && error.message.includes("500")) {
              errorMessage = "Server error - please try again later";
            }

            this.showNotification("error", "Analysis Failed", errorMessage);
          } finally {
            this.isAnalyzing = false;
            this.analysisProgress.percent = 100;
            this.analysisProgress.message = "Complete";
          }
        },

        // Direct API calls with better error handling
        async callQuickAnalysis(tokenMint) {
          console.log("📞 Calling quick analysis API...");

          try {
            const response = await fetch(`/quick/${tokenMint}`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });
            console.log("📡 Quick analysis response status:", response.status);
            if (!response.ok) {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(
                errorData.message ||
                  errorData.detail ||
                  `HTTP ${response.status}`
              );
            }
            const data = await response.json();
            console.log("✅ Quick analysis data received:", data);
            return data;
          } catch (error) {
            console.error("❌ Quick analysis failed:", error);
            throw error;
          }
        },

        showNotification(type, title, message) {
          // Try to use parent notification system
          if (this.$parent && this.$parent.showNotification) {
            this.$parent.showNotification(type, title, message);
          }
          // Fallback to SolanaAI notifications
          else if (window.SolanaAI && window.SolanaAI.notifications) {
            window.SolanaAI.notifications[type](title, message);
          }
          // Use custom toast notification
          else if (window.showToast) {
            window.showToast(type, title, message);
          }
          // Absolute fallback
          else {
            console.log(`${type.toUpperCase()}: ${title} - ${message}`);
            alert(`${title}: ${message}`);
          }
        },

        // Helper functions to extract data from results with null safety
        getTokenName() {
          if (!this.results) return "Unknown Token";

          // Try different paths with null safety
          const heliusName =
            this.results?.service_responses?.helius?.metadata?.onChainMetadata
              ?.metadata?.data?.name;
          if (heliusName) return heliusName;

          const solanafmName =
            this.results?.service_responses?.solanafm?.token?.name;
          if (solanafmName) return solanafmName;

          const dexName =
            this.results?.service_responses?.dexscreener?.pairs?.pairs?.[0]
              ?.baseToken?.name;
          if (dexName) return dexName;

          return "Unknown Token";
        },

        getTokenSymbol() {
          if (!this.results) return "N/A";

          const heliusSymbol =
            this.results?.service_responses?.helius?.metadata?.onChainMetadata
              ?.metadata?.data?.symbol;
          if (heliusSymbol) return heliusSymbol;

          const solanafmSymbol =
            this.results?.service_responses?.solanafm?.token?.symbol;
          if (solanafmSymbol) return solanafmSymbol;

          const dexSymbol =
            this.results?.service_responses?.dexscreener?.pairs?.pairs?.[0]
              ?.baseToken?.symbol;
          if (dexSymbol) return dexSymbol;

          return "N/A";
        },

        getPriceData() {
          if (!this.results) return {};

          // Check for Birdeye price data first
          const birdeyePrice = this.results?.service_responses?.birdeye?.price;
          if (birdeyePrice) {
            return {
              value: birdeyePrice.value,
              price_change_24h: birdeyePrice.price_change_24h,
              volume_24h: birdeyePrice.volume_24h,
              market_cap: birdeyePrice.market_cap,
              liquidity: birdeyePrice.liquidity,
            };
          }

          return {};
        },

        getQuickAnalysis() {
          if (!this.results) return null;

          // Check for overall analysis as quick analysis
          if (this.results.overall_analysis) {
            return {
              score: this.results.overall_analysis.score / 100, // Normalize to 0-1
              risk_level: this.results.overall_analysis.risk_level,
              recommendation: this.results.overall_analysis.recommendation,
              key_insights:
                this.results.overall_analysis.positive_signals || [],
              processing_time:
                this.results.metadata?.processing_time_seconds || 0,
              confidence: this.results.overall_analysis.confidence_score || 0,
            };
          }

          return null;
        },

        getDeepAnalysis() {
          return null; // Not implemented yet
        },

        getSecurityAnalysis() {
          if (!this.results) return null;

          // Extract security data from service responses
          const goplusData = this.results?.service_responses?.goplus?.security;
          const rugcheckData =
            this.results?.service_responses?.rugcheck?.report;

          if (goplusData || rugcheckData) {
            return {
              overall_security_score: rugcheckData?.score || 50,
              risk_factors: this.results?.overall_analysis?.risk_factors || [],
              security_warnings: [],
            };
          }

          return null;
        },

        getOnChainMetrics() {
          if (!this.results) return null;

          const heliusData = this.results?.service_responses?.helius;
          const chainbaseData = this.results?.service_responses?.chainbase;

          if (heliusData || chainbaseData) {
            return {
              holder_analysis: {
                holder_count: chainbaseData?.holders?.total_holders || 0,
                concentration: {},
              },
              transaction_activity: {
                "24h_transactions": 0,
                average_transaction_size: 0,
              },
            };
          }

          return null;
        },

        getRiskAssessment() {
          if (!this.results) return null;

          if (this.results.risk_assessment) {
            return this.results.risk_assessment;
          }

          return null;
        },

        getAnalysisScore() {
          if (!this.results) return null;

          if (this.results.overall_analysis?.score) {
            return Math.round(this.results.overall_analysis.score);
          }

          return null;
        },

        getRiskLevel() {
          if (!this.results) return "UNKNOWN";

          if (this.results.overall_analysis?.risk_level) {
            return this.results.overall_analysis.risk_level.toUpperCase();
          }

          if (this.results.risk_assessment?.risk_category) {
            return this.results.risk_assessment.risk_category.toUpperCase();
          }

          return "UNKNOWN";
        },

        getDataSources() {
          if (!this.results) return [];

          if (
            this.results.data_sources &&
            Array.isArray(this.results.data_sources)
          ) {
            return this.results.data_sources;
          }

          if (this.results.service_responses) {
            return Object.keys(this.results.service_responses);
          }

          return [];
        },

        isComprehensiveAnalysis() {
          return this.form.analysisType === "comprehensive" && this.results;
        },

        async pasteFromClipboard() {
          try {
            const text = await navigator.clipboard.readText();
            if (this.isValidSolanaAddress(text)) {
              this.form.tokenMint = text;
              this.showNotification(
                "success",
                "Pasted",
                "Token address pasted from clipboard"
              );
            } else {
              this.showNotification(
                "warning",
                "Invalid Format",
                "Clipboard content is not a valid Solana address"
              );
            }
          } catch (error) {
            this.showNotification(
              "error",
              "Paste Failed",
              "Failed to access clipboard"
            );
          }
        },

        clearResults() {
          this.hasResults = false;
          this.results = null;
          this.form.tokenMint = "";
        },

        exportResults() {
          if (!this.results) return;

          const data = {
            ...this.results,
            exported_at: new Date().toISOString(),
            export_format: "json",
            analysis_type: this.form.analysisType,
          };

          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `token-analysis-${this.form.tokenMint.substring(0, 8)}-${
            new Date().toISOString().split("T")[0]
          }.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          this.showNotification(
            "success",
            "Export Complete",
            "Analysis results exported successfully"
          );
        },

        // Utility functions
        truncateAddress(address) {
          if (!address) return "N/A";
          return (
            window.SolanaAI?.utils?.truncateAddress?.(address) ||
            (address.length > 16
              ? `${address.substring(0, 8)}...${address.substring(
                  address.length - 8
                )}`
              : address)
          );
        },

        formatCurrency(value) {
          if (!value && value !== 0) return "N/A";
          return (
            window.SolanaAI?.utils?.formatCurrency?.(value) ||
            parseFloat(value).toFixed(6)
          );
        },

        formatNumber(num) {
          if (!num && num !== 0) return "0";
          return window.SolanaAI?.utils?.formatNumber?.(num) || num.toString();
        },

        formatPercent(num) {
          if (!num && num !== 0) return "0%";
          return (
            window.SolanaAI?.utils?.formatPercent?.(num) ||
            `${num > 0 ? "+" : ""}${num.toFixed(2)}%`
          );
        },

        isValidSolanaAddress(address) {
          if (!address || typeof address !== "string") return false;
          if (address.length < 32 || address.length > 44) return false;
          return /^[1-9A-HJ-NP-Za-km-z]+$/.test(address);
        },

        getPriceChangeClass(change) {
          if (!change) return "text-gray-500";
          return parseFloat(change) >= 0 ? "text-green-600" : "text-red-600";
        },

        getRiskLevelClass(level) {
          const classes = {
            low: "bg-green-100 text-green-800",
            medium: "bg-yellow-100 text-yellow-800",
            high: "bg-red-100 text-red-800",
            critical: "bg-red-200 text-red-900",
          };
          return classes[level?.toLowerCase()] || "bg-gray-100 text-gray-800";
        },

        getRecommendationClass(recommendation) {
          const classes = {
            BUY: "bg-green-100 text-green-800",
            CONSIDER: "bg-blue-100 text-blue-800",
            HOLD: "bg-yellow-100 text-yellow-800",
            CAUTION: "bg-orange-100 text-orange-800",
            AVOID: "bg-red-100 text-red-800",
          };
          return classes[recommendation] || "bg-gray-100 text-gray-800";
        },
      };
    }
  </script>

  <!-- Toast Notification System -->
  <style>
    #toast-container {
      position: fixed;
      top: 1rem;
      right: 1rem;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 99999;
    }
    .toast {
      min-width: 250px;
      max-width: 350px;
      padding: 12px 16px;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    .toast.success {
      background: #16a34a;
    }
    .toast.error {
      background: #dc2626;
    }
    .toast.warning {
      background: #d97706;
    }
    .toast.info {
      background: #2563eb;
    }
    .toast-title {
      font-weight: bold;
      display: block;
    }
    .toast-message {
      font-size: 13px;
      opacity: 0.9;
    }
  </style>

  <div id="toast-container"></div>

  <script>
    window.showToast = function (type, title, message, timeout = 4000) {
      const container = document.getElementById("toast-container");

      const toast = document.createElement("div");
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <span class="toast-title">${title}</span>
        <span class="toast-message">${message}</span>
      `;

      container.appendChild(toast);

      // trigger animation
      setTimeout(() => toast.classList.add("show"), 50);

      // auto-remove after timeout
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => toast.remove(), 300);
      }, timeout);
    };
  </script>

  {% endblock %}
</div>
