<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      {% block title %}Solana Token Analysis AI System{% endblock %}
    </title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome Icons -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      rel="stylesheet"
    />

    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Alpine.js with Collapse Plugin -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"
    ></script>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <!-- Custom CSS -->
    <link
      href="{{ url_for('static', path='css/main.css') }}"
      rel="stylesheet"
    />

    <style>
      [x-cloak] {
        display: none !important;
      }

      .notification-overlay {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 60; /* Higher than popup z-index of 50 */
        pointer-events: none; /* Allow clicks through container */
      }

      .notification-item {
        pointer-events: auto; /* Re-enable clicks on actual notification */
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.75rem;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1),
          0 10px 10px -5px rgba(0, 0, 0, 0.04);
        padding: 1rem;
        max-width: 20rem;
        margin-bottom: 0.5rem;
      }

      .notification-success {
        border-left: 4px solid #10b981;
      }
      .notification-error {
        border-left: 4px solid #ef4444;
      }
      .notification-warning {
        border-left: 4px solid #f59e0b;
      }
      .notification-info {
        border-left: 4px solid #3b82f6;
      }

      .popup-hidden {
        display: none !important;
      }

      * {
        font-family: "Inter", sans-serif;
      }

      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .card-hover {
        transition: all 0.3s ease;
      }

      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      }

      .status-healthy {
        background-color: #10b981;
        box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
      }

      .status-unhealthy {
        background-color: #ef4444;
        box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
      }

      .status-warning {
        background-color: #f59e0b;
        box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
      }

      .loading-spinner {
        border: 3px solid #f3f4f6;
        border-top: 3px solid #3b82f6;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .pulse-glow {
        animation: pulseGlow 2s infinite;
      }

      @keyframes pulseGlow {
        0%,
        100% {
          box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
        }
        50% {
          box-shadow: 0 0 20px rgba(59, 130, 246, 0.6);
        }
      }

      .recommendation-buy {
        background: linear-gradient(135deg, #10b981, #34d399);
      }
      .recommendation-sell {
        background: linear-gradient(135deg, #ef4444, #f87171);
      }
      .recommendation-hold {
        background: linear-gradient(135deg, #f59e0b, #fbbf24);
      }
      .recommendation-avoid {
        background: linear-gradient(135deg, #6b7280, #9ca3af);
      }

      /* Fixed layout styles */
      .header-fixed {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 50;
        transition: left 0.3s ease;
      }

      .sidebar-fixed {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 16rem; /* 256px */
        z-index: 40;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }

      .sidebar-open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
        padding-top: 4rem; /* Header height */
        min-height: 100vh;
        transition: margin-left 0.3s ease;
      }

      /* Mobile: sidebar overlay, header spans full width */
      @media (max-width: 1023px) {
        .header-fixed {
          left: 0 !important;
          right: 0;
        }

        .sidebar-fixed {
          z-index: 60; /* Above header on mobile */
        }

        .main-content {
          margin-left: 0 !important;
          padding-top: 5rem; /* Extra space for mobile header with search */
        }
      }

      /* Desktop: sidebar pushes header and content */
      @media (min-width: 1024px) {
        .sidebar-fixed {
          transform: translateX(0);
          z-index: 30; /* Below header on desktop */
        }

        .header-fixed {
          left: 16rem; /* Sidebar width */
        }

        .main-content {
          margin-left: 16rem;
          padding-top: 4rem;
        }
      }

      .sidebar-overlay {
        position: fixed;
        inset: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 40; /* Below sidebar */
      }

      /* Prevent body scroll when mobile sidebar is open */
      body.sidebar-open-mobile {
        overflow: hidden;
      }
    </style>
  </head>
  <body
    class="h-full bg-gray-50"
    x-data="appData()"
    x-init="init()"
    @close-sidebar="closeSidebar()"
  >
    <!-- Loading Screen -->
    <div
      x-show="loading"
      x-transition
      class="fixed inset-0 bg-white z-50 flex items-center justify-center"
    >
      <div class="text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <h2 class="text-xl font-semibold text-gray-900">
          Loading AI System...
        </h2>
        <p class="text-gray-600 mt-2">
          Initializing components and checking system health
        </p>
      </div>
    </div>

    <!-- Sidebar Overlay for Mobile -->
    <div
      x-show="sidebarOpen && !isDesktop && !loading"
      x-transition:enter="transition-opacity ease-linear duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition-opacity ease-linear duration-300"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-black bg-opacity-50 z-40"
      @click="closeSidebar()"
    ></div>

    <!-- Main App -->
    <div x-show="!loading" x-transition class="h-full">
      <!-- Header -->
      {% include 'components/header.html' %}

      <!-- Sidebar -->
      {% include 'components/sidebar.html' %}

      <!-- Main Content -->
      <main class="main-content">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
          {% block content %}{% endblock %}
        </div>
      </main>
    </div>

    <!-- Toast Notifications -->
    <div
      x-show="notification && !loading"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0 transform translate-x-full"
      x-transition:enter-end="opacity-100 transform translate-x-0"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100 transform translate-x-0"
      x-transition:leave-end="opacity-0 transform translate-x-full"
      class="notification-overlay"
    >
      <div
        class="notification-item"
        :class="{
      'notification-success': notification?.type === 'success',
      'notification-error': notification?.type === 'error',
      'notification-warning': notification?.type === 'warning',
      'notification-info': notification?.type === 'info'
    }"
      >
        <div class="flex items-start">
          <!-- Icon -->
          <div class="flex-shrink-0">
            <i
              class="text-lg"
              :class="{
            'fas fa-check-circle text-green-500': notification?.type === 'success',
            'fas fa-exclamation-circle text-red-500': notification?.type === 'error',
            'fas fa-exclamation-triangle text-yellow-500': notification?.type === 'warning',
            'fas fa-info-circle text-blue-500': notification?.type === 'info'
          }"
            ></i>
          </div>

          <!-- Content -->
          <div class="ml-3 flex-1">
            <p
              class="font-semibold text-gray-900 text-sm"
              x-text="notification?.title || ''"
            ></p>
            <p
              class="text-sm text-gray-600 mt-1"
              x-text="notification?.message || ''"
            ></p>
          </div>

          <!-- Close Button -->
          <button
            @click="hideNotification()"
            class="ml-4 text-gray-400 hover:text-gray-600 transition-colors"
          >
            <i class="fas fa-times text-sm"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Analysis Popup -->
    <div
      x-show="!loading && showAnalysisPopup"
      x-cloak
      style="display: none"
      class="fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4"
    >
      <div
        class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto"
        @click.stop
      >
        <!-- Header -->
        <div
          class="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 rounded-t-xl"
        >
          <div class="flex justify-between items-center">
            <div>
              <h2
                class="text-2xl font-bold"
                x-text="(popupAnalysis?.token_symbol || 'Unknown') + ' Analysis'"
              ></h2>
              <p
                class="opacity-90"
                x-text="popupAnalysis?.token_name || 'Token Analysis Results'"
              ></p>
            </div>
            <button
              @click="closeAnalysisPopup()"
              class="text-white hover:text-gray-300 text-2xl"
            >
              &times;
            </button>
          </div>
        </div>

        <!-- Content -->
        <div class="p-6" x-show="popupAnalysis">
          <!-- Status Cards -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <!-- Security -->
            <div
              class="text-center p-4 rounded-lg border-2"
              :class="{
               'bg-green-50 border-green-200': popupAnalysis?.security_status === 'passed',
               'bg-red-50 border-red-200': popupAnalysis?.security_status === 'failed',
               'bg-yellow-50 border-yellow-200': popupAnalysis?.security_status === 'warning',
               'bg-gray-50 border-gray-200': !popupAnalysis?.security_status || popupAnalysis?.security_status === 'unknown'
             }"
            >
              <div
                class="text-2xl mb-2"
                :class="{
                 'text-green-600': popupAnalysis?.security_status === 'passed',
                 'text-red-600': popupAnalysis?.security_status === 'failed',
                 'text-yellow-600': popupAnalysis?.security_status === 'warning',
                 'text-gray-600': !popupAnalysis?.security_status || popupAnalysis?.security_status === 'unknown'
               }"
              >
                🛡️
              </div>
              <div
                class="font-bold"
                x-text="popupAnalysis?.security_status === 'passed' ? 'SECURE' :
                      popupAnalysis?.security_status === 'failed' ? 'UNSAFE' :
                      popupAnalysis?.security_status === 'warning' ? 'CAUTION' : 'UNKNOWN'"
              ></div>
              <div class="text-xs text-gray-500">Security</div>
            </div>

            <!-- Score -->
            <div
              class="text-center p-4 rounded-lg bg-blue-50 border-2 border-blue-200"
            >
              <div class="text-2xl mb-2 text-blue-600">⭐</div>
              <div
                class="font-bold text-blue-900"
                x-text="popupAnalysis?.overall_score ? Math.round(popupAnalysis.overall_score) + '%' : 'N/A'"
              ></div>
              <div class="text-xs text-gray-500">Score</div>
            </div>

            <!-- Risk -->
            <div
              class="text-center p-4 rounded-lg border-2"
              :class="{
               'bg-green-50 border-green-200': popupAnalysis?.risk_level === 'low',
               'bg-yellow-50 border-yellow-200': popupAnalysis?.risk_level === 'medium',
               'bg-orange-50 border-orange-200': popupAnalysis?.risk_level === 'high',
               'bg-red-50 border-red-200': popupAnalysis?.risk_level === 'critical',
               'bg-gray-50 border-gray-200': !popupAnalysis?.risk_level || popupAnalysis?.risk_level === 'unknown'
             }"
            >
              <div
                class="text-2xl mb-2"
                :class="{
                 'text-green-600': popupAnalysis?.risk_level === 'low',
                 'text-yellow-600': popupAnalysis?.risk_level === 'medium',
                 'text-orange-600': popupAnalysis?.risk_level === 'high',
                 'text-red-600': popupAnalysis?.risk_level === 'critical',
                 'text-gray-600': !popupAnalysis?.risk_level || popupAnalysis?.risk_level === 'unknown'
               }"
              >
                ⚠️
              </div>
              <div
                class="font-bold"
                x-text="popupAnalysis?.risk_level?.toUpperCase() || 'UNKNOWN'"
              ></div>
              <div class="text-xs text-gray-500">Risk</div>
            </div>

            <!-- Recommendation -->
            <div
              class="text-center p-4 rounded-lg bg-purple-50 border-2 border-purple-200"
            >
              <div class="text-2xl mb-2 text-purple-600">👍</div>
              <div
                class="font-bold text-purple-900"
                x-text="popupAnalysis?.recommendation?.toUpperCase() || 'UNKNOWN'"
              ></div>
              <div class="text-xs text-gray-500">Action</div>
            </div>
          </div>

          <!-- Security Details -->
          <div class="mb-6">
            <h3 class="font-bold text-lg mb-3">🔍 Security Details</h3>

            <!-- Critical Issues -->
            <div
              x-show="(popupAnalysis?.critical_issues || 0) > 0"
              class="bg-red-50 border-l-4 border-red-500 p-4 mb-3 rounded-r-lg"
            >
              <div class="flex items-center mb-2">
                <span class="text-red-500 text-xl mr-2">🚨</span>
                <div class="font-bold text-red-800">
                  Critical Security Issues
                </div>
              </div>
              <div
                class="text-red-700 mb-2"
                x-text="(popupAnalysis?.critical_issues || 0) + ' critical issue(s) detected'"
              ></div>
              <div class="text-sm text-red-600 bg-red-100 p-2 rounded">
                <strong>⚠️ High Risk:</strong> This token has failed critical
                security checks. Issues may include active mint authority
                (unlimited supply), freeze authority (can freeze accounts), or
                other dangerous permissions that could harm investors.
              </div>
            </div>

            <!-- Warnings -->
            <div
              x-show="(popupAnalysis?.warnings || 0) > 0"
              class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-3 rounded-r-lg"
            >
              <div class="flex items-center mb-2">
                <span class="text-yellow-500 text-xl mr-2">⚠️</span>
                <div class="font-bold text-yellow-800">Security Warnings</div>
              </div>
              <div
                class="text-yellow-700 mb-2"
                x-text="(popupAnalysis?.warnings || 0) + ' warning(s) detected'"
              ></div>
              <div class="text-sm text-yellow-700 bg-yellow-100 p-2 rounded">
                <strong>⚠️ Moderate Risk:</strong> This token has some
                concerning features that warrant caution. Warnings may include
                upgradeable transfer fees, closable accounts, low holder count,
                or other factors that could indicate potential risks. Research
                thoroughly before trading.
              </div>
            </div>

            <!-- All Clear -->
            <div
              x-show="(popupAnalysis?.critical_issues || 0) === 0 && (popupAnalysis?.warnings || 0) === 0 && popupAnalysis?.security_status === 'passed'"
              class="bg-green-50 border-l-4 border-green-500 p-4 mb-3 rounded-r-lg"
            >
              <div class="flex items-center mb-2">
                <span class="text-green-500 text-xl mr-2">✅</span>
                <div class="font-bold text-green-800">Security Verified</div>
              </div>
              <div class="text-sm text-green-700 bg-green-100 p-2 rounded">
                <strong>✅ Low Risk:</strong> This token has passed all security
                checks. No critical issues or warnings detected. The token
                appears to have safe configurations with minimal dangerous
                authorities.
              </div>
            </div>

            <!-- Analysis Info -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
              <div class="flex items-center mb-2">
                <span class="text-blue-500 text-xl mr-2">ℹ️</span>
                <div class="font-bold text-blue-800">Analysis Information</div>
              </div>
              <div class="text-sm text-blue-700 space-y-1">
                <div>
                  <strong>Processed:</strong>
                  <span x-text="popupAnalysis?.time || 'Unknown'"></span>
                </div>
                <div>
                  <strong>Processing Time:</strong>
                  <span
                    x-text="(popupAnalysis?.processing_time || 0).toFixed(2) + 's'"
                  ></span>
                </div>
                <div>
                  <strong>Source:</strong>
                  <span
                    x-text="(popupAnalysis?.source_event || 'unknown').replace('_', ' ')"
                  ></span>
                </div>
                <div x-show="popupAnalysis?.id">
                  <strong>Analysis ID:</strong>
                  <code
                    class="text-xs bg-blue-100 px-1 rounded"
                    x-text="popupAnalysis?.id ? popupAnalysis.id.substring(0, 16) + '...' : 'N/A'"
                  ></code>
                </div>
              </div>
            </div>
          </div>

          <!-- Token Address -->
          <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <div class="font-bold mb-2">📋 Contract Address</div>
            <div class="flex items-center justify-between">
              <code
                class="text-sm bg-white px-2 py-1 rounded break-all"
                x-text="popupAnalysis?.mint || 'N/A'"
              ></code>
              <button
                x-show="popupAnalysis?.mint"
                @click="copyToClipboard(popupAnalysis.mint)"
                class="ml-2 px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600"
              >
                Copy
              </button>
            </div>
          </div>
          <!-- Export Section -->
          <div class="bg-gray-50 rounded-lg p-4 mb-6">
            <div class="font-bold mb-3">📄 Export Analysis</div>
            <div class="space-y-3">
              <!-- DOCX Export Button - IMPROVED STYLING -->
              <button
                @click="exportPopupAnalysis()"
                :disabled="isExporting"
                class="w-full px-6 py-3 rounded-lg text-sm font-semibold transition-all duration-200 flex items-center justify-center shadow-md hover:shadow-lg transform hover:scale-[1.02] disabled:transform-none disabled:hover:scale-100"
                :class="isExporting ? 
        'bg-blue-500 text-white cursor-wait' : 
        'bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white'"
              >
                <i
                  class="mr-2 text-base"
                  :class="isExporting ? 'fas fa-spinner fa-spin' : 'fas fa-file-word'"
                ></i>
                <span x-show="!isExporting" class="font-medium">
                  Export Professional DOCX Report
                </span>
                <span x-show="isExporting" class="font-medium">
                  Generating Report...
                </span>
              </button>

              <!-- Enhanced Status Text -->
              <div class="text-center">
                <div
                  class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-700"
                >
                  <i class="fas fa-check-circle mr-1"></i>
                  Professional DOCX report ready for download
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="{{ url_for('static', path='js/main.js') }}"></script>

    <script>
      function appData() {
        return {
          loading: true,
          sidebarOpen: false,
          isDesktop: false,
          currentPage: "{{ request.url.path }}",
          systemHealth: null,
          notification: null,
          realMetrics: {
            totalAnalyses: 0,
            successRate: 0,
            avgResponseTime: 0,
            activeTokens: 0,
          },

          // Popup properties
          showAnalysisPopup: false,
          popupAnalysis: null,

          // Export properties
          isExporting: false,

          init() {
            // Check screen size
            this.checkScreenSize();
            this.sidebarOpen = this.isDesktop;
            this.showAnalysisPopup = false;
            this.popupAnalysis = null;

            // Initialize app
            setTimeout(() => {
              this.loading = false;
            }, 1000);

            this.loadSystemHealth();
            this.loadRealMetrics();

            // Handle window resize
            window.addEventListener("resize", () => {
              const wasDesktop = this.isDesktop;
              this.checkScreenSize();

              if (this.isDesktop && !wasDesktop) {
                this.sidebarOpen = true;
                document.body.classList.remove("sidebar-open-mobile");
              } else if (!this.isDesktop && wasDesktop) {
                this.sidebarOpen = false;
                document.body.classList.remove("sidebar-open-mobile");
              }
            });

            window.openAnalysisPopupGlobal = (data) => {
              console.log("🚀 GLOBAL: Opening popup with:", data);
              if (!this.loading) {
                this.popupAnalysis = data;
                this.showAnalysisPopup = true;
                document.body.style.overflow = "hidden";
              }
            };

            window.closeAnalysisPopupGlobal = () => {
              console.log("🔒 GLOBAL: Closing popup");
              this.showAnalysisPopup = false;
              this.popupAnalysis = null;
              document.body.style.overflow = "";
            };

            window.copyToClipboardGlobal = async (text) => {
              try {
                await navigator.clipboard.writeText(text);
                this.showNotification(
                  "success",
                  "Copied",
                  "Address copied to clipboard"
                );
              } catch (error) {
                this.showNotification(
                  "error",
                  "Copy Failed",
                  "Failed to copy to clipboard"
                );
              }
            };

            window.openFullAnalysisGlobal = (tokenAddress) => {
              if (tokenAddress) {
                this.closeAnalysisPopup();
                window.location.href = `/analysis?token=${tokenAddress}`;
              }
            };

            console.log("✅ Global popup functions created");
          },

          checkScreenSize() {
            this.isDesktop = window.innerWidth >= 1024;
          },

          async loadSystemHealth() {
            try {
              const response = await fetch("/health");
              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              const healthData = await response.json();
              this.systemHealth = {
                overall_status: Boolean(healthData?.overall_status),
                services:
                  healthData?.services &&
                  typeof healthData.services === "object"
                    ? healthData.services
                    : {},
                summary: {
                  healthy_services:
                    Number(healthData?.summary?.healthy_services) || 0,
                  total_services:
                    Number(healthData?.summary?.total_services) || 0,
                },
                recommendations: Array.isArray(healthData?.recommendations)
                  ? healthData.recommendations.filter(
                      (rec) => rec && typeof rec === "string"
                    )
                  : [],
                timestamp:
                  Number(healthData?.timestamp) ||
                  Math.floor(Date.now() / 1000),
              };

              console.log(
                "✅ System health loaded successfully:",
                this.systemHealth
              );
            } catch (error) {
              console.error("Failed to load system health:", error);
              this.systemHealth = {
                overall_status: false,
                services: {},
                summary: { healthy_services: 0, total_services: 0 },
                recommendations: [],
                timestamp: Math.floor(Date.now() / 1000),
              };
            }
          },

          async loadRealMetrics() {
            try {
              const response = await fetch("/api/dashboard");
              if (response.ok) {
                const data = await response.json();
                if (data.metrics) {
                  this.realMetrics = data.metrics;
                }
              }
            } catch (error) {
              console.error("Failed to load real metrics:", error);
            }
          },

          toggleSidebar() {
            this.sidebarOpen = !this.sidebarOpen;
            if (!this.isDesktop) {
              if (this.sidebarOpen) {
                document.body.classList.add("sidebar-open-mobile");
              } else {
                document.body.classList.remove("sidebar-open-mobile");
              }
            }
          },

          closeSidebar() {
            if (!this.isDesktop) {
              this.sidebarOpen = false;
              document.body.classList.remove("sidebar-open-mobile");
            }
          },

          showNotification(type, title, message) {
            this.notification = { type, title, message };
            setTimeout(() => {
              this.hideNotification();
            }, 5000);
          },

          hideNotification() {
            this.notification = null;
          },

          // Popup methods
          openAnalysisPopup(analysisData) {
            console.log("📊 Opening analysis popup:", analysisData);
            this.popupAnalysis = analysisData;
            this.showAnalysisPopup = true;
            document.body.style.overflow = "hidden";
          },

          closeAnalysisPopup() {
            this.showAnalysisPopup = false;
            this.popupAnalysis = null;
            document.body.style.overflow = "";
          },

          async copyToClipboard(text) {
            try {
              await navigator.clipboard.writeText(text);
              this.showNotification(
                "success",
                "Copied",
                "Address copied to clipboard"
              );
            } catch (error) {
              this.showNotification(
                "error",
                "Copy Failed",
                "Failed to copy to clipboard"
              );
            }
          },

          openFullAnalysis(tokenAddress) {
            if (tokenAddress) {
              this.closeAnalysisPopup();
              window.location.href = `/analysis?token=${tokenAddress}`;
            }
          },

          getCacheKey() {
            if (!this.popupAnalysis) return;

            const source = this.popupAnalysis.source_event;
            const namespace =
              source === "api_quick"
                ? "token_analysis:analysis"
                : "enhanced_token_analysis:deep_analysis";

            return `${namespace}:${this.popupAnalysis.mint}`;
          },

          async exportPopupAnalysis() {
            if (!this.popupAnalysis) {
              this.showNotification(
                "error",
                "Export Failed",
                "No analysis data available"
              );
              return;
            }

            this.isExporting = true;

            try {
              await this.downloadDocxReport();
            } catch (error) {
              console.error("Export failed:", error);
              this.handleExportError(error);
            } finally {
              this.isExporting = false;
            }
          },

          handleExportError(error) {
            let errorMessage = "Failed to export analysis";
            let errorTitle = "Export Failed";

            if (
              error.message.includes("expired") ||
              error.message.includes("404")
            ) {
              errorTitle = "Analysis Refreshed";
              errorMessage =
                "Running fresh analysis to generate your report. This may take a moment...";

              // Try again after a short delay for fresh analysis
              setTimeout(() => {
                this.showNotification(
                  "info",
                  "Retrying...",
                  "Attempting to generate report from fresh analysis"
                );
                this.exportPopupAnalysis();
              }, 2000);
              return;
            } else if (
              error.message.includes("network") ||
              error.message.includes("fetch")
            ) {
              errorTitle = "Network Error";
              errorMessage =
                "Failed to download report due to network issues. Please try again.";
            } else if (
              error.message.includes("server") ||
              error.message.includes("500")
            ) {
              errorTitle = "Server Error";
              errorMessage =
                "Report generation failed on server. Please try again in a moment.";
            } else if (error.message) {
              errorMessage = error.message;
            }

            this.showNotification("error", errorTitle, errorMessage);
          },

          async downloadDocxReport() {
            try {
              this.showNotification(
                "info",
                "Generating Report",
                "Creating professional DOCX document..."
              );

              const cacheKey = this.getCacheKey();
              if (!cacheKey) {
                throw new Error("Unable to generate report cache key");
              }

              // Detect analysis type from popup data
              const source = this.popupAnalysis.source_event;

              let response = await fetch(
                `/document/${encodeURIComponent(cacheKey)}?source=${source}`
              );

              // If cache miss (404), backend runs fresh analysis automatically
              if (response.status === 404) {
                this.showNotification(
                  "info",
                  "Running Fresh Analysis",
                  "Cache expired, analyzing token again..."
                );
                await new Promise((resolve) => setTimeout(resolve, 5000));
                response = await fetch(
                  `/document/${encodeURIComponent(cacheKey)}?source=${source}`
                );
              }

              if (!response.ok) {
                throw new Error(
                  `Report generation failed (${response.status})`
                );
              }

              const blob = await response.blob();
              if (blob.size === 0) {
                throw new Error("Generated report is empty");
              }

              // Download file
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url;

              const tokenSymbol = this.popupAnalysis.token_symbol || "Unknown";
              const tokenShort = (
                this.popupAnalysis.mint || "unknown"
              ).substring(0, 8);
              const date = new Date().toISOString().split("T")[0];
              const time = new Date()
                .toTimeString()
                .split(" ")[0]
                .replace(/:/g, "-");

              a.download = `${tokenSymbol}_Analysis_${tokenShort}_${date}_${time}.docx`;

              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              window.URL.revokeObjectURL(url);

              this.showNotification(
                "success",
                "Download Complete",
                `Report for ${tokenSymbol} downloaded successfully`
              );
            } catch (error) {
              console.error("DOCX download failed:", error);
              throw error;
            }
          },
        };
      }
    </script>

    {% block scripts %}{% endblock %}
  </body>
</html>
